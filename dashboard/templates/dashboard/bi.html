{% extends 'base.html' %}
{% load humanize %}

{% block title %}Business Intelligence | Portal.flow{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Inteligencia de Negocios</h1>
            <p class="text-sm text-gray-500">Análisis estratégico para la toma de decisiones</p>
        </div>
        
        <!-- Controls -->
        <div class="flex items-center space-x-3 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
            <input type="date" id="date_from" class="text-sm border-gray-200 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            <span class="text-gray-400">a</span>
            <input type="date" id="date_to" class="text-sm border-gray-200 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            
            <button onclick="loadDashboard()" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition-colors shadow-sm">
                Actualizar
            </button>
        </div>
    </div>

    <!-- Top KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- GMROI Avg -->
        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-boxes text-4xl text-indigo-600"></i>
            </div>
            <div class="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-1">RENTABILIDAD STOCK (GMROI)</div>
            <div class="flex items-baseline">
                <div class="text-2xl font-bold text-slate-800" id="kpi-gmroi-avg">--</div>
                <span class="ml-2 text-xs font-medium text-gray-400">Promedio</span>
            </div>
            <div class="mt-2 text-xs text-gray-500">
                Objetivo: > 3.0
            </div>
        </div>
        
        <!-- CCC -->
        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-money-bill-wave text-4xl text-green-600"></i>
            </div>
            <div class="text-xs font-bold text-green-600 uppercase tracking-wider mb-1">CICLO DE EFECTIVO (CCC)</div>
            <div class="flex items-baseline">
                <div class="text-2xl font-bold text-slate-800" id="kpi-ccc-days">--</div>
                <span class="ml-1 text-sm font-medium text-gray-500">días</span>
            </div>
             <div class="mt-2 text-xs" id="kpi-ccc-status">
                --
            </div>
        </div>
        
        <!-- CLV Avg -->
        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-users text-4xl text-purple-600"></i>
            </div>
            <div class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-1">VALOR DE VIDA (CLV)</div>
             <div class="flex items-baseline">
                <div class="text-2xl font-bold text-slate-800" id="kpi-clv-avg">--</div>
                <span class="ml-2 text-xs font-medium text-gray-400">Promedio Top 20%</span>
            </div>
             <div class="mt-2 text-xs text-gray-500">
                Proyección a 3 años
            </div>
        </div>
        
        <!-- Pareto -->
        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-chart-pie text-4xl text-orange-600"></i>
            </div>
            <div class="text-xs font-bold text-orange-600 uppercase tracking-wider mb-1">CONCENTRACIÓN (PARETO)</div>
            <div class="flex items-baseline">
                <div class="text-2xl font-bold text-slate-800" id="kpi-pareto-a">--%</div>
                <span class="ml-2 text-xs font-medium text-gray-400">Ingresos x Prod. A</span>
            </div>
            <div class="mt-2 text-xs text-gray-500" id="kpi-pareto-count">
                -- productos generan 80% vtas
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- GMROI Matrix -->
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm h-96 flex flex-col">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                <i class="fas fa-th text-indigo-500 mr-2"></i> Matriz de Rentabilidad de Productos
            </h3>
            <div class="flex-1 relative">
                <canvas id="gmroiChart"></canvas>
            </div>
        </div>

        <!-- CCC Breakdown -->
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm h-96 flex flex-col">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                <i class="fas fa-stopwatch text-green-500 mr-2"></i> Ciclo de Conversión de Efectivo
            </h3>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <div class="text-xs text-blue-600 font-bold mb-1">DIO (Inventario)</div>
                    <div class="text-xl font-bold text-blue-800" id="ccc-dio">--</div>
                    <div class="text-[10px] text-blue-400">días ventas</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-xs text-green-600 font-bold mb-1">DSO (Cobro)</div>
                    <div class="text-xl font-bold text-green-800" id="ccc-dso">--</div>
                    <div class="text-[10px] text-green-400">días cobro</div>
                </div>
                <div class="text-center p-3 bg-red-50 rounded-lg">
                    <div class="text-xs text-red-600 font-bold mb-1">DPO (Pago)</div>
                    <div class="text-xl font-bold text-red-800" id="ccc-dpo">--</div>
                    <div class="text-[10px] text-red-400">días pago</div>
                </div>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-lg text-sm border-l-4 border-slate-300" id="ccc-recommendation">
                Calculando recomendaciones...
            </div>
            
             <div class="mt-auto pt-4 text-xs text-gray-400 text-center">
                CCC = DIO + DSO - DPO. Buscamos el menor valor posible.
            </div>
        </div>
    </div>
    
    <!-- Detailed Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Top CLV Customers -->
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="font-bold text-slate-800 flex items-center">
                    <i class="fas fa-crown text-purple-500 mr-2"></i> Top Clientes por Valor (CLV)
                </h3>
                <button onclick="window.location.href='{% url 'export_customers' %}'" class="text-xs font-bold text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-download mr-1"></i> Excel
                </button>
            </div>
           
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-xs text-gray-500 border-b border-gray-100">
                            <th class="py-2 text-left font-medium">Cliente</th>
                            <th class="py-2 text-right font-medium">Ticket Prom.</th>
                            <th class="py-2 text-right font-medium">CLV Proy.</th>
                            <th class="py-2 text-right font-medium">Segmento</th>
                        </tr>
                    </thead>
                    <tbody id="clv-table-body">
                        <!-- JS populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pareto ABC -->
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="font-bold text-slate-800 flex items-center">
                    <i class="fas fa-sort-amount-down text-orange-500 mr-2"></i> Análisis ABC Productos
                </h3>
                 <button onclick="window.location.href='{% url 'export_inventory' %}'" class="text-xs font-bold text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-download mr-1"></i> Excel
                </button>
            </div>
            
            <div class="flex mb-4 text-xs">
                <div class="flex-1 bg-green-100 text-green-800 p-2 text-center rounded-l-lg border-r border-white">
                    <div class="font-bold" id="abc-a-count">--</div>
                    <div>Clase A (80%)</div>
                </div>
                <div class="w-1/4 bg-yellow-100 text-yellow-800 p-2 text-center border-r border-white">
                    <div class="font-bold" id="abc-b-count">--</div>
                    <div>Clase B (15%)</div>
                </div>
                 <div class="w-1/4 bg-red-100 text-red-800 p-2 text-center rounded-r-lg">
                    <div class="font-bold" id="abc-c-count">--</div>
                    <div>Clase C (5%)</div>
                </div>
            </div>

            <div class="overflow-x-auto custom-scrollbar" style="max-height: 300px;">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-xs text-gray-500 border-b border-gray-100">
                            <th class="py-2 text-left font-medium">Producto</th>
                            <th class="py-2 text-right font-medium">Ingresos</th>
                            <th class="py-2 text-center font-medium">Clase</th>
                        </tr>
                    </thead>
                    <tbody id="abc-table-body">
                         <!-- JS populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Stock Forecast Section (NEW) -->
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden mb-6">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
            <div>
                 <h3 class="font-bold text-slate-800 flex items-center">
                    <i class="fas fa-brain text-purple-500 mr-2"></i> Inteligencia de Stock (Runway)
                </h3>
                <p class="text-xs text-gray-500 mt-1">Estimación de días restantes de materia prima basada en consumo reciente.</p>
            </div>
             <span class="text-xs font-semibold px-2 py-1 bg-purple-50 text-purple-600 rounded">Actualizado: Hoy</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50/50 text-gray-400 text-xs uppercase tracking-wider border-b border-gray-100">
                        <th class="p-4 font-semibold">Materia Prima</th>
                        <th class="p-4 font-semibold text-right">Stock Actual</th>
                        <th class="p-4 font-semibold text-right">Consumo Diario</th>
                        <th class="p-4 font-semibold text-center">Estado</th>
                        <th class="p-4 font-semibold text-right">Días Restantes</th>
                        <th class="p-4 font-semibold text-right">Agotamiento Est.</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 text-sm">
                    {% for item in forecasts %}
                    <tr class="hover:bg-gray-50/50 transition-colors">
                        <td class="p-4">
                            <div class="font-medium text-slate-700">{{ item.ingredient.name }}</div>
                            <div class="text-[10px] text-gray-400">{{ item.ingredient.get_unit_display }}</div>
                        </td>
                        <td class="p-4 text-right text-slate-600 font-mono">
                            {{ item.ingredient.stock_quantity|floatformat:2 }}
                        </td>
                        <td class="p-4 text-right text-slate-600 font-mono">
                            {{ item.daily_usage|floatformat:2 }}
                        </td>
                        <td class="p-4 text-center">
                            {% if item.status == 'CRITICAL' %}
                                <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-red-100 text-red-700 border border-red-200">
                                    CRÍTICO
                                </span>
                            {% elif item.status == 'WARNING' %}
                                <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">
                                    ALERTA
                                </span>
                            {% else %}
                                <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-green-100 text-green-700 border border-green-200">
                                    SEGURO
                                </span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-right font-bold {% if item.runway_days < 7 %}text-red-600{% elif item.runway_days < 30 %}text-yellow-600{% else %}text-green-600{% endif %}">
                            {% if item.runway_days > 1000 %}
                                ∞
                            {% else %}
                                {{ item.runway_days|floatformat:1 }} días
                            {% endif %}
                        </td>
                        <td class="p-4 text-right text-gray-500 text-xs">
                            {% if item.depletion_date %}
                                {{ item.depletion_date|date:"d M Y" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="p-8 text-center text-gray-400 italic">
                            No hay datos suficientes para calcular pronósticos.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let gmroiChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        // Set default dates (Last 90 days)
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 90);
        
        document.getElementById('date_to').valueAsDate = end;
        document.getElementById('date_from').valueAsDate = start;
        
        loadDashboard();
    });

    async function loadDashboard() {
        const from = document.getElementById('date_from').value;
        const to = document.getElementById('date_to').value;
        const params = `?date_from=${from}&date_to=${to}&_t=${Date.now()}`;

        // Load all in parallel
        Promise.all([
            fetch(`{% url 'api_gmroi' %}${params}`).then(r => r.json()),
            fetch(`{% url 'api_ccc' %}${params}`).then(r => r.json()),
            fetch(`{% url 'api_clv' %}${params}`).then(r => r.json()),
            fetch(`{% url 'api_abc' %}${params}`).then(r => r.json())
        ]).then(([gmroi, ccc, clv, abc]) => {
            renderGMROI(gmroi);
            renderCCC(ccc);
            renderCLV(clv);
            renderABC(abc);
        }).catch(err => console.error("Error loading BI data:", err));
    }

    function formatCurrency(val) {
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(val);
    }

    // --- Renders ---

    function renderGMROI(data) {
        const products = data.products || [];
        
        // Avg GMROI for top 20 items (to avoid skew from tiny items)
        const topProducts = products.slice(0, 20);
        const avgGmroi = topProducts.reduce((sum, p) => sum + p.gmroi, 0) / (topProducts.length || 1);
        document.getElementById('kpi-gmroi-avg').innerText = avgGmroi.toFixed(1);
        
        // Chart: Scatter (Rotación vs Rentabilidad)
        const ctx = document.getElementById('gmroiChart').getContext('2d');
        if (gmroiChart) gmroiChart.destroy();
        
        const chartData = topProducts.map(p => ({
            x: p.turnover, // Rotación
            y: p.gmroi,    // Rentabilidad
            r: Math.min(Math.max(p.revenue / 10000, 5), 20), // Radio = Ingresos (clamped)
            product: p.product_name,
            class: p.classification
        }));

        gmroiChart = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'Productos',
                    data: chartData,
                    backgroundColor: chartData.map(d => {
                        if (d.class === 'ESTRELLA') return 'rgba(34, 197, 94, 0.6)';
                        if (d.class === 'VACA LECHERA') return 'rgba(59, 130, 246, 0.6)';
                        if (d.class === 'INTERROGANTE') return 'rgba(234, 179, 8, 0.6)';
                        return 'rgba(239, 68, 68, 0.6)';
                    }),
                    borderColor: 'rgba(0,0,0,0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const p = ctx.raw;
                                return `${p.product}: GMROI ${p.y.toFixed(1)} / Rot ${p.x.toFixed(1)}`;
                            }
                        }
                    },
                    annotation: {
                        // Idealmente dibujar cuadrantes aquí, pero annotation plugin quizás no esté cargado.
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'Rotación (Veces)' },
                        min: 0
                    },
                    y: { 
                        title: { display: true, text: 'GMROI (Rentabilidad)' },
                        min: 0
                    }
                }
            }
        });
    }

    function renderCCC(data) {
        document.getElementById('kpi-ccc-days').innerText = data.ccc.toFixed(0);
        
        const statusEl = document.getElementById('kpi-ccc-status');
        let color = 'text-gray-500';
        if (data.interpretation === 'EXCELENTE' || data.interpretation === 'MUY BUENO') color = 'text-green-600';
        else if (data.interpretation === 'ACEPTABLE') color = 'text-yellow-600';
        else color = 'text-red-600';
        
        statusEl.className = `mt-2 text-xs font-bold ${color}`;
        statusEl.innerText = data.interpretation;
        
        document.getElementById('ccc-dio').innerText = isNaN(data.dio) ? '-' : data.dio.toFixed(1);
        document.getElementById('ccc-dso').innerText = isNaN(data.dso) ? '-' : data.dso.toFixed(1);
        document.getElementById('ccc-dpo').innerText = isNaN(data.dpo) ? '-' : data.dpo.toFixed(1);
        
        const recEl = document.getElementById('ccc-recommendation');
        recEl.innerText = data.recommendation;
        recEl.className = `bg-slate-50 p-4 rounded-lg text-sm border-l-4 ${color.replace('text-', 'border-')}`;
    }

    function renderCLV(data) {
        const customers = data.customers || [];
        const topCustomers = customers.slice(0, Math.ceil(customers.length * 0.2)); // Top 20%
        const avgClv = topCustomers.reduce((sum, c) => sum + c.clv_adjusted, 0) / (topCustomers.length || 1);
        
        document.getElementById('kpi-clv-avg').innerText = formatCurrency(avgClv);
        
        const tbody = document.getElementById('clv-table-body');
        tbody.innerHTML = '';
        customers.slice(0, 5).forEach(c => {
            tbody.innerHTML += `
            <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                <td class="py-2 font-medium text-slate-800">${c.customer_name}</td>
                <td class="py-2 text-right text-gray-600">${formatCurrency(c.avg_ticket)}</td>
                <td class="py-2 text-right font-bold text-indigo-600">${formatCurrency(c.clv_adjusted)}</td>
                <td class="py-2 text-right text-xs">
                    <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full">${c.segment || 'N/A'}</span>
                </td>
            </tr>
            `;
        });
    }

    function renderABC(data) {
        const products = data.products || [];
        const summary = data.summary || {};
        
        document.getElementById('kpi-pareto-a').innerText = Math.round((summary.total_revenue > 0 ? products.filter(p=>p.category==='A').reduce((s,p)=>s+p.revenue,0)/summary.total_revenue : 0) * 100) + '%';
        document.getElementById('kpi-pareto-count').innerText = `${summary.category_a_count} productos generan el 80%`;
        
        document.getElementById('abc-a-count').innerText = summary.category_a_count;
        document.getElementById('abc-b-count').innerText = summary.category_b_count;
        document.getElementById('abc-c-count').innerText = summary.category_c_count;
        
        const tbody = document.getElementById('abc-table-body');
        tbody.innerHTML = '';
        products.slice(0, 10).forEach(p => {
             let color = 'bg-green-100 text-green-800';
             if (p.category === 'B') color = 'bg-yellow-100 text-yellow-800';
             if (p.category === 'C') color = 'bg-red-100 text-red-800';
             
             tbody.innerHTML += `
             <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                <td class="py-2 font-medium text-slate-700 truncate" style="max-width: 150px;" title="${p.product_name}">${p.product_name}</td>
                <td class="py-2 text-right text-gray-600">${formatCurrency(p.revenue)}</td>
                <td class="py-2 text-center">
                    <span class="px-2 py-0.5 rounded text-xs font-bold ${color}">${p.category}</span>
                </td>
             </tr>
             `;
        });
    }

</script>
{% endblock %}
